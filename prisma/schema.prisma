generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ✅ الأدوار
enum UserRole {
  admin
  booking
  security
  ops
}

// ✅ حالة الرحلة
enum TripStatus {
  scheduled
  boarding
  departed
  canceled
  completed
}

// ✅ الجنس
enum Gender {
  M
  F
}

// ✅ طرق المسح
enum ScanMethod {
  manual
  qr
  nfc
  other
}

// ✅ حالة المقاعد
enum SeatStatus {
  available
  held
  reserved
  blocked
}

model User {
  id            BigInt       @id @default(autoincrement())
  name          String       @db.VarChar(120)
  phone         String?      @db.VarChar(40)
  role          UserRole
  passwordHash  String?      @db.VarChar(255)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  refreshTokens String[]     @default([])

  // العلاقات
  trips         Trip[]        @relation("TripCreator")
  reservations  Reservation[] @relation("ReservationCreator")
  securityLogs  SecurityLog[] @relation("LogRecorder")
}

model BusType {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(80)
  seatCount  Int

  // ✅ الحقول الجديدة لتخطيط الباص
  rows        Int?
  leftSeats   Int?
  rightSeats  Int?
  lastRowSeats Int?

  // العلاقات
  seats      Seat[]
  trips      Trip[]
}

model Seat {
  id        Int        @id @default(autoincrement())
  busTypeId Int
  row       Int
  col       Int
  number    Int
  status    SeatStatus @default(available)  // ✅ حالة المقعد

  // العلاقات
  busType     BusType   @relation(fields: [busTypeId], references: [id])
  tripSeats   TripSeat[]
  reservations Reservation[]
}

model Trip {
  id               BigInt      @id @default(autoincrement())
  busTypeId        Int
  busType          BusType     @relation(fields: [busTypeId], references: [id])
  departureDt      DateTime
  originLabel      String?     @db.VarChar(120)
  destinationLabel String?     @db.VarChar(120)
  durationMinutes  Int?
  driverName       String?     @db.VarChar(120)
  status           TripStatus  @default(scheduled)
  createdBy        BigInt
  creator          User        @relation("TripCreator", fields: [createdBy], references: [id])
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // العلاقات
  tripSeats     TripSeat[]
  reservations  Reservation[]
  securityLogs  SecurityLog[]
}

model TripSeat {
  tripId  BigInt
  seatId  Int
  status  SeatStatus @default(available)  // ✅ حالة المقعد على مستوى الرحلة

  trip    Trip @relation(fields: [tripId], references: [id])
  seat    Seat @relation(fields: [seatId], references: [id])

  @@id([tripId, seatId])
}

model Reservation {
  id            BigInt    @id @default(autoincrement())
  tripId        BigInt
  seatId        Int
  passengerName String    @db.VarChar(120)
  phone         String?   @db.VarChar(40)
  boardingPoint String?   @db.VarChar(120)
  notes         String?   @db.VarChar(255)
  paid          Boolean   @default(false)
  amount        Decimal  
  createdBy     BigInt
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // العلاقات
  trip          Trip      @relation(fields: [tripId], references: [id])
  seat          Seat      @relation(fields: [seatId], references: [id])
  creator       User      @relation("ReservationCreator", fields: [createdBy], references: [id])
  securityLogs  SecurityLog[]
}

model SecurityLog {
  id            BigInt      @id @default(autoincrement())
  tripId        BigInt
  reservationId BigInt?
  nationalId    String      @db.VarChar(20)   // ✅ أبقينا الرقم الوطني
  firstName     String      @db.VarChar(60)
  lastName      String      @db.VarChar(60)
  fatherName    String?     @db.VarChar(60)
  motherName    String?     @db.VarChar(60)
  birthDate     DateTime?   @db.Date
  issuePlace    String?     @db.VarChar(80)
  phone         String?     @db.VarChar(40)
  notes         String?     @db.VarChar(255)
  recordedAt    DateTime    @default(now())
  recordedBy    BigInt

  // العلاقات
  trip          Trip        @relation(fields: [tripId], references: [id])
  reservation   Reservation? @relation(fields: [reservationId], references: [id])
  recorder      User        @relation("LogRecorder", fields: [recordedBy], references: [id])

  @@index([tripId, recordedAt])
  @@index([reservationId])
}
